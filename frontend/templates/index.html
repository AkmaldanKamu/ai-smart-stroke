<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiTANGGAP - Sistem Tangkap Gejala Stroke Cepat</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-brain"></i> SiTANGGAP</h1>
            <p class="subtitle">Sistem Tangkap Gejala Stroke Cepat - Deteksi Dini untuk Penanganan Tepat</p>
        </div>

        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <h2><i class="fas fa-robot"></i> AI Deteksi Stroke Terdepan</h2>
                    <p>SiTANGGAP menggunakan teknologi Artificial Intelligence (AI) canggih untuk mendeteksi gejala stroke secara dini melalui analisis ekspresi wajah dan pola bicara.</p>
                    <p>Sistem ini dikembangkan dengan algoritma machine learning yang telah dilatih menggunakan ribuan data medis untuk memberikan hasil deteksi yang akurat dan cepat.</p>
                    <p><strong>Deteksi dini stroke dapat menyelamatkan nyawa!</strong> Setiap menit sangat berharga dalam penanganan stroke.</p>
                </div>
                <div class="hero-visual">
                    <div class="stats-section">
                        <div class="stat-card">
                            <div class="stat-number">85%</div>
                            <div class="stat-label">Akurasi Deteksi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">
                                < 30s</div>
                                    <div class="stat-label">Waktu Analisis</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">2</div>
                                <div class="stat-label">Metode Deteksi</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Features -->
            <div class="ai-features">
                <div class="feature-card">
                    <i class="fas fa-eye"></i>
                    <h3>Analisis Ekspresi Wajah</h3>
                    <p>AI menganalisis asimetri wajah, ptosis mata, dan kemiringan senyuman untuk mendeteksi gejala stroke facial palsy.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-microphone-alt"></i>
                    <h3>Analisis Pola Bicara</h3>
                    <p>Sistem mengevaluasi kejelasan artikulasi, kecepatan bicara, dan pola intonasi untuk mendeteksi disartria.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-chart-line"></i>
                    <h3>Scoring NIHSS</h3>
                    <p>Menggunakan skala NIHSS (National Institutes of Health Stroke Scale) untuk penilaian tingkat keparahan stroke.</p>
                </div>
            </div>

            <!-- Technology Section -->
            <div class="tech-section">
                <h3><i class="fas fa-cogs"></i> Teknologi yang Digunakan</h3>
                <div class="tech-grid">
                    <div class="tech-item">
                        <i class="fas fa-brain"></i>
                        <h4>Deep Learning</h4>
                        <p>Neural networks untuk analisis wajah</p>
                    </div>
                    <div class="tech-item">
                        <i class="fas fa-wave-square"></i>
                        <h4>Signal Processing</h4>
                        <p>Analisis sinyal suara digital</p>
                    </div>
                    <div class="tech-item">
                        <i class="fas fa-eye"></i>
                        <h4>Computer Vision</h4>
                        <p>Deteksi landmarks wajah</p>
                    </div>
                    <div class="tech-item">
                        <i class="fas fa-microphone"></i>
                        <h4>Speech Recognition</h4>
                        <p>Konversi suara ke teks</p>
                    </div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="disclaimer-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Disclaimer Penting</h3>
                <p><strong>PERHATIAN:</strong> SiTANGGAP adalah alat bantu deteksi dini yang menggunakan teknologi AI. Sistem ini <strong>TIDAK</strong> dapat menggantikan diagnosis medis profesional.</p>
                <p><strong>Penting untuk diingat:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Hasil deteksi AI bersifat indikatif, bukan diagnosis pasti</li>
                    <li>Segera konsultasi dengan dokter atau tenaga medis jika mendapat hasil positif</li>
                    <li>Jangan menunda penanganan medis berdasarkan hasil AI</li>
                    <li>Dalam keadaan darurat, hubungi 119 atau rumah sakit terdekat</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Keamanan Data:</strong> Semua data video dan audio diproses secara lokal dan tidak disimpan di server.</p>
            </div>

            <!-- CTA Section -->
            <div class="cta-section">
                <h3><i class="fas fa-rocket"></i> Mulai Deteksi Sekarang</h3>
                <p>Lakukan tes deteksi stroke dengan AI dalam hitungan menit. Pastikan Anda berada di ruangan dengan pencahayaan yang baik.</p>
                <button class="start-test-btn" onclick="document.getElementById('video').scrollIntoView({behavior: 'smooth'})">
                <i class="fas fa-play-circle"></i> Mulai Tes Deteksi
            </button>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="camera-section">
                    <h2><i class="fas fa-camera"></i> Kamera Deteksi</h2>
                    <video id="video" width="400" height="300" autoplay muted></video>
                </div>

                <div class="controls-section">
                    <h2><i class="fas fa-cogs"></i> Kontrol Tes</h2>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="deteksiWajah()">
                        <i class="fas fa-smile"></i> Tes Ekspresi Wajah
                    </button>
                        <button id="btn-voice" class="btn btn-secondary" onclick="mulaiTesSuara()">
                        <i class="fas fa-microphone"></i> Tes Ucapan
                    </button>
                        <button id="btn-diagnosa" class="btn btn-success" onclick="diagnosaStroke()" disabled>
                        <i class="fas fa-search"></i> Cek Diagnosa Stroke
                    </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2><i class="fas fa-chart-line"></i> Hasil Deteksi</h2>

                <div class="result-item">
                    <p id="hasil-wajah">Belum ada hasil deteksi wajah</p>
                    <ul id="detail-wajah"></ul>
                </div>

                <div class="result-item">
                    <p id="status-audio">Belum ada hasil deteksi suara</p>
                    <p id="transkrip-audio"></p>
                    <p id="skor-audio"></p>
                </div>
            </div>

            <!-- Diagnosis Section -->
            <div class="diagnosis-section">
                <h2><i class="fas fa-stethoscope"></i> Diagnosa Stroke</h2>

                <div class="diagnosis-result">
                    <p id="diagnosa-hasil">Silakan lakukan tes wajah dan suara terlebih dahulu</p>
                    <p id="diagnosa-penanganan"></p>
                </div>

                <div class="diagnosis-summary">
                    <ul id="diagnosa-summary"></ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>&copy; 2024 SiTANGGAP - Sistem Deteksi Stroke Dini | Kesehatan adalah prioritas utama</p>
                <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8;">
                    Dikembangkan dengan teknologi AI untuk membantu deteksi dini stroke. Selalu konsultasikan dengan tenaga medis profesional.
                </p>
            </div>
        </div>

        <script defer>
            const video = document.getElementById("video");
            const hasilDeteksi = {
                wajah: null,
                suara: null,
                face_score: null,
                suara_score: null
            };

            function startSmartCamera() {
                navigator.mediaDevices.enumerateDevices().then(devices => {
                    const cams = devices.filter(d => d.kind === 'videoinput');
                    const selected = cams.find(d => !d.label.toLowerCase().includes("iriun")) || cams[0];

                    if (!selected) {
                        alert("❌ Tidak ada kamera terdeteksi.");
                        return;
                    }

                    navigator.mediaDevices.getUserMedia({
                            video: {
                                deviceId: {
                                    ideal: selected.deviceId
                                }
                            }
                        })
                        .then(stream => {
                            video.srcObject = stream;
                        })
                        .catch(err => {
                            alert("❌ Gagal akses kamera: " + err.name);
                        });
                });
            }

            startSmartCamera();

            function ambilFrameBase64() {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0);
                return canvas.toDataURL("image/jpeg");
            }

            function updateDiagnosaButton() {
                const btn = document.getElementById("btn-diagnosa");
                btn.disabled = !(hasilDeteksi.wajah && hasilDeteksi.suara);
            }

            // =====================
            // 🚨 DETEKSI WAJAH
            // =====================
            function deteksiWajah() {
                Swal.fire({
                    title: '📸 Siap untuk Deteksi Wajah',
                    text: 'Senyum ke kamera, wajah di tengah, jangan miring.',
                    icon: 'info',
                    confirmButtonText: 'Mulai'
                }).then(() => lanjutDeteksiWajah());
            }

            function lanjutDeteksiWajah() {
                const el = document.getElementById("hasil-wajah");
                const detail = document.getElementById("detail-wajah");
                el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendeteksi ekspresi wajah...';
                detail.innerHTML = "";

                const imageBase64 = ambilFrameBase64();

                fetch("/detect-face", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            image: imageBase64
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status !== "ok") {
                            el.innerHTML = `❌ Gagal deteksi wajah: ${data.message}`;
                            return;
                        }

                        hasilDeteksi.wajah = data.kategori;
                        hasilDeteksi.face_score = data.score_total;

                        el.innerHTML = `✅ Wajah: ${data.kategori}`;
                        const p = data.penilaian;
                        detail.innerHTML = `
                        <li><strong>🧠 Total Skor Wajah:</strong> ${data.score_total}/6</li>
                        <li><strong>💡 Saran:</strong> ${data.saran}</li>
                        <hr>
                        <li><strong>👄 Bibir</strong></li>
                        <ul><li>Delta Y: ${p.bibir.delta_y}</li><li>Rasio X: ${p.bibir.rasio_x}</li><li>Skor: ${p.bibir.nilai}/2</li></ul>
                        <li><strong>👁️ Mata</strong></li>
                        <ul><li>Delta Openness: ${p.mata.delta_openness}</li><li>Ptosis: ${p.mata.ptosis_suspect ? "Ya" : "Tidak"}</li><li>Skor: ${p.mata.nilai}/2</li></ul>
                        <li><strong>🧭 Pipi</strong></li>
                        <ul><li>Kemiringan: ${p.pipi.kemiringan_derajat}°</li><li>Skor: ${p.pipi.nilai}/2</li></ul>
                    `;
                        updateDiagnosaButton();
                    })
                    .catch(() => el.innerHTML = "❌ Gagal deteksi wajah");
            }

            // =====================
            // 🎤 DETEKSI SUARA
            // =====================
            function mulaiTesSuara() {
                Swal.fire({
                    title: '🎤 Siap Tes Ucapan',
                    html: 'Ucapkan dengan jelas: <br><b>"Hari ini saya makan nasi"</b>',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Mulai Rekam'
                }).then(result => {
                    if (result.isConfirmed) {
                        rekamSuaraDanKirim();
                    }
                });
            }

            function rekamSuaraDanKirim() {
                const status = document.getElementById("status-audio");
                const transkrip = document.getElementById("transkrip-audio");
                const skor = document.getElementById("skor-audio");
                const btn = document.getElementById("btn-voice");

                btn.disabled = true;
                status.innerText = "⏺️ Merekam suara selama 5 detik...";
                transkrip.innerText = "";
                skor.innerText = "";

                navigator.mediaDevices.getUserMedia({
                        audio: true
                    })
                    .then(stream => {
                        const mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];

                        mediaRecorder.ondataavailable = e => {
                            if (e.data.size > 0) chunks.push(e.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(chunks, {
                                type: 'audio/webm'
                            });
                            const formData = new FormData();
                            formData.append('audio', audioBlob);

                            status.innerText = "🧠 Menganalisis suara...";

                            fetch("/analyze-audio", {
                                    method: "POST",
                                    body: formData
                                })
                                .then(res => res.json())
                                .then(data => {
                                    hasilDeteksi.suara = data.hasil;
                                    hasilDeteksi.suara_score = data.score;

                                    status.innerText = `✅ Hasil Suara: ${data.hasil}`;
                                    transkrip.innerText = `🗣️ Transkrip: ${data.transkrip}`;
                                    skor.innerText = `🎯 Skor Suara: ${data.score}/2`;

                                    btn.disabled = false;
                                    updateDiagnosaButton();
                                })
                                .catch(() => {
                                    status.innerText = "❌ Gagal menganalisis suara.";
                                    btn.disabled = false;
                                });
                        };

                        mediaRecorder.start();
                        setTimeout(() => {
                            mediaRecorder.stop();
                            stream.getTracks().forEach(t => t.stop());
                        }, 5000);
                    })
                    .catch(err => {
                        Swal.fire('❌ Gagal akses mikrofon', err.message, 'error');
                        btn.disabled = false;
                    });
            }

            // =====================
            // 🔍 DIAGNOSA FINAL
            // =====================
            function diagnosaStroke() {
                const output = document.getElementById("diagnosa-hasil");
                const summary = document.getElementById("diagnosa-summary");
                const penanganan = document.getElementById("diagnosa-penanganan");

                output.innerText = "⏳ Menganalisis semua indikator...";
                summary.innerHTML = "";
                penanganan.innerText = "";

                fetch("/diagnosa", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            image: ambilFrameBase64(),
                            face_score: hasilDeteksi.face_score,
                            face_kategori: hasilDeteksi.wajah,
                            voice_result: hasilDeteksi.suara,
                            voice_score: hasilDeteksi.suara_score
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status !== "ok") {
                            output.innerText = `❌ Gagal diagnosa: ${data.message}`;
                            return;
                        }

                        output.innerText = `🧠 Skor NIHSS: ${data.skor} (${data.kategori})\n📢 ${data.saran}`;
                        penanganan.innerText = `🩺 Tindakan: ${data.penanganan || "-"}`;

                        data.summary.forEach(item => {
                            const li = document.createElement("li");
                            li.innerText = item;
                            summary.appendChild(li);
                        });
                    })
                    .catch(() => {
                        output.innerText = "❌ Terjadi error saat diagnosa.";
                    });
            }
        </script>


</body>

</html>